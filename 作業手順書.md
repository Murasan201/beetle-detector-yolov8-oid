# Beetle Detector YOLOv8 作業手順書

## プロジェクト概要
YOLOv8とOpen Images Dataset (OID)を使用してBeetle（甲虫）検出モデルを作成するプロジェクト

## 作業工程一覧

### Phase 1: 環境構築・準備（完了）
1. **環境セットアップ** ✅
   - [x] Pythonバーチャル環境作成（`.venv`）
   - [x] 必要なライブラリのインストール（ultralytics, fiftyone, torch等）
   - [x] GPU環境確認（CPU環境での軽量テスト対応）

2. **プロジェクト構成確立** ✅
   - [x] ディレクトリ構造作成（scripts/, datasets/, docs/, runs/）
   - [x] CLAUDE.mdルールファイル作成
   - [x] requirements.txt作成
   - [x] 実行スクリプト一式作成

### Phase 2: データ取得・前処理（実行可能）
3. **Open Images Datasetからのデータ取得** 🚀
   - [x] FiftyOneを使用したOIDアクセス設定（スクリプト作成済み）
   - [ ] Beetleクラスのデータ抽出（軽量版: train 200枚、val 50枚 / フル版: train 1200枚、val 300枚）
   - [ ] データセット品質確認
   
   **実行コマンド:**
   ```bash
   # 軽量テスト（推奨開始）
   python scripts/01_download_oid_beetle.py
   
   # フルスケール
   python scripts/01_download_oid_beetle.py --full-scale
   ```

4. **データクリーニング・前処理** 🚀
   - [x] 壊れた画像の除去機能（スクリプト作成済み）
   - [x] 小さすぎるバウンディングボックスの除去（8px以下、64px²以下）
   - [x] アノテーションの品質チェック機能
   
   **実行コマンド:**
   ```bash
   python scripts/02_clean_and_export_yolo.py
   ```

5. **YOLO形式への変換** 🚀
   - [x] OID形式からYOLO形式へのアノテーション変換
   - [x] data.yamlファイル生成
   - [x] データセット分割確認（train/val）
   - [x] ATTRIBUTION.csv自動生成（ライセンス遵守）

### Phase 3: モデル訓練・評価（実行可能）
6. **YOLOv8ベースライン訓練** 🚀
   - [x] yolov8n.ptからの転移学習スクリプト作成
   - [x] CPU最適化モード（20エポック、バッチ4）
   - [x] テストモード（30エポック、バッチ8）
   - [x] フルスケールモード（80エポック、バッチ16）
   - [x] 学習曲線の監視機能
   
   **実行コマンド:**
   ```bash
   # CPU最適化（30分程度）
   bash scripts/03_train_yolov8.sh --cpu-optimized
   
   # テストモード（1時間程度）
   bash scripts/03_train_yolov8.sh
   
   # フルスケール（GPU推奨、3-4時間）
   bash scripts/03_train_yolov8.sh --full-scale
   ```

7. **モデル評価** 🚀
   - [x] 検証データでのmAP@0.5計算（目標: ≥0.60）
   - [x] PR曲線、混同行列の可視化
   - [x] 誤検出分析・エラーブラウジング
   - [x] 推論速度ベンチマーク
   
   **実行コマンド:**
   ```bash
   jupyter notebook scripts/04_eval_report.ipynb
   ```

8. **モデル最適化**
   - [x] ハイパーパラメータ調整オプション
   - [x] 複数モデルサイズ対応（n/s/m）
   - [ ] 実行結果に基づく調整

### Phase 4: 推論・デプロイ（実行可能）
9. **推論システム構築** ✅
   - [x] 推論用CLIスクリプト作成（05_infer_cli.py）
   - [x] バッチ処理機能実装
   - [x] 信頼度閾値調整機能
   - [x] JSON出力対応
   
   **実行コマンド:**
   ```bash
   # 単一画像
   python scripts/05_infer_cli.py -m runs/detect/train/weights/best.pt -s image.jpg
   
   # ディレクトリ一括処理
   python scripts/05_infer_cli.py -m best.pt -s images/ --conf 0.5
   ```

10. **性能検証** 🚀
    - [x] テスト画像での推論精度確認機能
    - [x] 推論速度計測機能
    - [x] 信頼度閾値分析
    - [ ] 実際のテスト実行

### Phase 5: ドキュメント・法的コンプライアンス（完了）
11. **ライセンス管理** ✅
    - [x] ATTRIBUTION.csv自動生成機能（使用画像の出典・ライセンス記録）
    - [x] OID利用規約遵守（CC BY 4.0 / CC BY 2.0）
    - [x] 画像再配布禁止の明記

12. **ドキュメント整備** ✅
    - [x] README.md作成（包括的な実行手順、サンプル結果、トラブルシューティング）
    - [x] 評価レポート自動生成（Jupyterノートブック）
    - [x] 作業手順書（日本語詳細版）
    - [x] CLAUDE.mdルールファイル

### Phase 6: 検証・納品（実行可能）
13. **最終検証** 🚀
    - [x] 再現性確保（スクリプト化・自動化済み）
    - [x] ワンコマンド実行対応
    - [ ] 実際の性能検証実行
    
    **クイックテスト手順:**
    ```bash
    # 1. データダウンロード
    python scripts/01_download_oid_beetle.py
    
    # 2. データ前処理
    python scripts/02_clean_and_export_yolo.py
    
    # 3. 軽量訓練（30分）
    bash scripts/03_train_yolov8.sh --cpu-optimized
    
    # 4. 評価
    jupyter notebook scripts/04_eval_report.ipynb
    
    # 5. 推論テスト
    python scripts/05_infer_cli.py -m runs/detect/train/weights/best.pt -s test.jpg
    ```

14. **成果物整理** 🚀
    - [x] 学習済み重みファイル自動保存（runs/detect/train/weights/）
    - [x] 結果可視化自動生成
    - [x] 包括的レポート作成機能

## 使用スクリプト一覧
- `scripts/01_download_oid_beetle.py` - OIDデータダウンロード
- `scripts/02_clean_and_export_yolo.py` - データクリーニング・YOLO変換
- `scripts/03_train_yolov8.sh` - YOLOv8訓練実行
- `scripts/04_eval_report.ipynb` - 評価・可視化
- `scripts/05_infer_cli.py` - 推論CLI

## 重要な注意事項
- 作業開始時は必ず要件定義書「REQUIREMENTS_beetle-detector-yolov8-oid.md」を確認
- OID画像は再配布禁止
- 各画像の個別ライセンス確認が必要
- mAP@0.5 ≥ 0.60の精度目標達成
- 単一クラス（Beetle）のみの検出

## 現在の進行状況

### ✅ 完了済み（Phase 1, 5）
- 環境構築・依存関係インストール
- 全スクリプト作成・テスト準備完了
- ドキュメント整備完了

### 🚀 実行可能（Phase 2, 3, 4, 6）
- データダウンロード・前処理
- モデル訓練・評価
- 推論・性能検証
- 最終検証

## 想定所要時間（更新）

### **軽量テスト（推奨開始）**
- **データ**: train 200枚、val 50枚
- **訓練**: CPU 30分、GPU 10分
- **合計**: 1-2時間（初回動作確認）

### **本格運用**
- **データ**: train 1200枚、val 300枚
- **訓練**: CPU 4-17日、GPU 3-4時間
- **合計**: GPU環境で半日、CPU環境で1-3週間

## 次のステップ
1. **軽量テスト実行**（動作確認）
2. **結果評価**
3. **必要に応じてGoogle Colab GPUで本格訓練**